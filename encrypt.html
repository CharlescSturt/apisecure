<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Encrypt API Key â€” API Secure</title>
  <meta name="description" content="Split your API key into two pieces for secure delivery. AES-256-GCM encryption in your browser.">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #111118;
      --bg-card: rgba(17, 17, 24, 0.8);
      --border-subtle: rgba(255, 255, 255, 0.08);
      --border-hover: rgba(0, 212, 255, 0.4);
      --cyan: #00d4ff;
      --cyan-glow: rgba(0, 212, 255, 0.3);
      --cyan-pulse: rgba(0, 212, 255, 0.15);
      --amber: #f59e0b;
      --amber-glow: rgba(245, 158, 11, 0.3);
      --green: #10b981;
      --green-glow: rgba(16, 185, 129, 0.3);
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7);
      --text-muted: rgba(255, 255, 255, 0.5);
      --danger: #ef4444;
      --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: var(--font-sans);
      background-color: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
      min-height: 100vh;
    }
    ::selection { background: var(--cyan-glow); color: var(--text-primary); }

    .container { max-width: 1200px; margin: 0 auto; padding: 0 24px; }

    .nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      padding: 16px 0;
      background: rgba(10, 10, 15, 0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border-subtle);
    }
    .nav-content { display: flex; align-items: center; justify-content: space-between; }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--text-primary);
      text-decoration: none;
    }
    .logo img { width: 32px; height: 32px; border-radius: 8px; }
    .nav-links { display: flex; align-items: center; gap: 32px; }
    .nav-link {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      transition: color 0.2s ease;
    }
    .nav-link:hover { color: var(--cyan); }

    .main {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      padding: 100px 24px 60px;
      overflow: hidden;
    }
    .particle-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    .encrypt-card {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 600px;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: 20px;
      padding: 48px;
      backdrop-filter: blur(20px);
      animation: fadeInUp 0.6s ease-out;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card-header { text-align: center; margin-bottom: 40px; }
    .card-icon {
      width: 70px;
      height: 70px;
      background: rgba(0, 212, 255, 0.1);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
    }
    .card-icon i { width: 36px; height: 36px; color: var(--cyan); }
    .card-title { font-size: 2rem; font-weight: 700; margin-bottom: 10px; }
    .card-subtitle { font-size: 1rem; color: var(--text-secondary); }

    /* Steps */
    .step-section {
      margin-bottom: 32px;
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    .step-section.hidden { display: none; }
    .step-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .step-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: var(--cyan);
      border-radius: 50%;
      font-family: var(--font-mono);
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--bg-primary);
    }
    .step-title {
      font-size: 1.2rem;
      font-weight: 600;
    }
    .step-description {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .form-group { margin-bottom: 24px; }
    .form-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 10px;
      color: var(--text-secondary);
    }
    .form-label-hint { font-size: 0.75rem; color: var(--text-muted); font-weight: 400; }
    .input-wrapper { position: relative; }
    .form-input {
      width: 100%;
      background: var(--bg-primary);
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      padding: 14px 44px 14px 16px;
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }
    .form-input:focus { outline: none; border-color: var(--cyan); box-shadow: 0 0 0 3px var(--cyan-glow); }
    .form-input::placeholder { color: var(--text-muted); }
    .input-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .input-toggle:hover { color: var(--cyan); background: rgba(0, 212, 255, 0.1); }
    .input-toggle i { width: 18px; height: 18px; }

    /* Delivery Mode Selection */
    .mode-cards {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    .mode-card {
      background: var(--bg-primary);
      border: 2px solid var(--border-subtle);
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    .mode-card:hover {
      border-color: var(--border-hover);
      transform: translateY(-2px);
    }
    .mode-card.selected {
      border-color: var(--cyan);
      background: rgba(0, 212, 255, 0.05);
    }
    .mode-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    .mode-radio {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-subtle);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    .mode-card.selected .mode-radio {
      border-color: var(--cyan);
      background: var(--cyan);
    }
    .mode-radio-dot {
      width: 8px;
      height: 8px;
      background: var(--bg-primary);
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .mode-card.selected .mode-radio-dot { opacity: 1; }
    .mode-card-title {
      font-size: 1.05rem;
      font-weight: 600;
    }
    .mode-card-badge {
      display: inline-block;
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: var(--green);
      padding: 4px 10px;
      border-radius: 100px;
      font-size: 0.7rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: auto;
    }
    .mode-card-badge.pro {
      background: rgba(0, 212, 255, 0.15);
      border-color: rgba(0, 212, 255, 0.3);
      color: var(--cyan);
    }
    .mode-card-desc {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    /* Buttons */
    .btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 16px 32px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      text-decoration: none;
    }
    .btn-primary {
      background: transparent;
      border: 2px solid var(--cyan);
      color: var(--cyan);
      position: relative;
      overflow: hidden;
    }
    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, var(--cyan-glow), transparent);
      transition: left 0.5s ease;
    }
    .btn-primary:hover:not(:disabled) {
      transform: scale(1.02);
      background: var(--cyan-glow);
      box-shadow: 0 0 30px var(--cyan-glow);
    }
    .btn-primary:hover:not(:disabled)::before { left: 100%; }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-primary.encrypting { animation: pulse-border 1.5s ease-in-out infinite; }
    @keyframes pulse-border {
      0%, 100% { box-shadow: 0 0 0 0 var(--cyan-pulse); }
      50% { box-shadow: 0 0 0 8px transparent; }
    }
    .btn-secondary {
      background: var(--bg-primary);
      border: 1px solid var(--border-subtle);
      color: var(--text-secondary);
    }
    .btn-secondary:hover {
      border-color: var(--cyan);
      color: var(--cyan);
    }
    .btn i { width: 20px; height: 20px; }

    /* Result Boxes */
    .result-section {
      margin-top: 32px;
      padding-top: 32px;
      border-top: 1px solid var(--border-subtle);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.4s ease;
      display: none;
    }
    .result-section.visible { opacity: 1; transform: translateY(0); display: block; }

    .piece-box {
      background: var(--bg-primary);
      border: 2px solid var(--border-subtle);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      position: relative;
    }
    .piece-box.warning {
      border-color: var(--amber);
      background: rgba(245, 158, 11, 0.05);
    }
    .piece-box.success {
      border-color: var(--green);
      background: rgba(16, 185, 129, 0.05);
    }
    .piece-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .piece-icon {
      width: 40px;
      height: 40px;
      background: rgba(0, 212, 255, 0.1);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .piece-box.warning .piece-icon { background: rgba(245, 158, 11, 0.15); }
    .piece-box.success .piece-icon { background: rgba(16, 185, 129, 0.15); }
    .piece-icon i { width: 22px; height: 22px; color: var(--cyan); }
    .piece-box.warning .piece-icon i { color: var(--amber); }
    .piece-box.success .piece-icon i { color: var(--green); }
    .piece-title {
      flex: 1;
      font-size: 1.1rem;
      font-weight: 600;
    }
    .piece-value-box {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      position: relative;
    }
    .piece-value {
      font-family: var(--font-mono);
      font-size: 0.85rem;
      color: var(--cyan);
      word-break: break-all;
      line-height: 1.6;
      padding-right: 60px;
    }
    .piece-copy-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border-subtle);
      color: var(--text-secondary);
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .piece-copy-btn:hover { border-color: var(--cyan); color: var(--cyan); background: rgba(0, 212, 255, 0.1); }
    .piece-copy-btn.copied { background: rgba(16, 185, 129, 0.15); border-color: var(--green); color: var(--green); }
    .piece-copy-btn i { width: 14px; height: 14px; }
    .piece-instruction {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }
    .piece-instruction strong { color: var(--text-primary); }

    .warning-box {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 10px;
      padding: 16px;
      display: flex;
      align-items: start;
      gap: 12px;
      margin-bottom: 24px;
    }
    .warning-box i { width: 20px; height: 20px; color: var(--amber); flex-shrink: 0; margin-top: 2px; }
    .warning-text {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }
    .warning-text strong { color: var(--amber); }

    .spinner { width: 20px; height: 20px; border: 2px solid var(--cyan); border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      padding: 14px 24px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      color: var(--text-primary);
      z-index: 1000;
      opacity: 0;
      transition: all 0.3s ease;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
    }
    .toast.visible { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast i { width: 18px; height: 18px; color: var(--green); }

    @media (max-width: 640px) {
      .nav-links { display: none; }
      .main { padding: 100px 16px 40px; }
      .encrypt-card { padding: 32px 24px; }
      .card-title { font-size: 1.6rem; }
      .piece-value { font-size: 0.75rem; }
    }
  </style>
</head>

<body>
  <nav class="nav">
    <div class="container">
      <div class="nav-content">
        <a href="/" class="logo">
          <img src="logo.png" alt="API Secure">
          <span>API Secure</span>
        </a>
        <div class="nav-links">
          <a href="index.html" class="nav-link">Home</a>
          <a href="docs.html" class="nav-link">Docs</a>
          <a href="pro.html" class="nav-link">Pro</a>
          <a href="decrypt.html" class="nav-link">Decrypt</a>
        </div>
      </div>
    </div>
  </nav>

  <main class="main">
    <canvas class="particle-canvas" id="particleCanvas"></canvas>
    <div class="encrypt-card">
      <div class="card-header">
        <div class="card-icon">
          <i data-lucide="lock"></i>
        </div>
        <h1 class="card-title">Encrypt & Split</h1>
        <p class="card-subtitle">Divide your secret into two pieces for secure delivery</p>
      </div>

      <!-- Step 1: Enter API Key -->
      <div class="step-section" id="step1">
        <div class="step-header">
          <span class="step-badge">1</span>
          <h2 class="step-title">Enter API Key</h2>
        </div>
        <div class="form-group">
          <label class="form-label">
            API Key
            <span class="form-label-hint">Never leaves your browser</span>
          </label>
          <div class="input-wrapper">
            <input type="password" class="form-input" id="apiKeyInput" placeholder="sk-..." autocomplete="off">
            <button class="input-toggle" id="toggleVisibility" title="Show/hide">
              <i data-lucide="eye"></i>
            </button>
          </div>
        </div>
        <button class="btn btn-primary" id="continueToMode">
          <span>Continue</span>
          <i data-lucide="arrow-right"></i>
        </button>
      </div>

      <!-- Step 2: Choose Delivery Mode -->
      <div class="step-section hidden" id="step2">
        <div class="step-header">
          <span class="step-badge">2</span>
          <h2 class="step-title">Choose Delivery Mode</h2>
        </div>
        <p class="step-description">How do you want to deliver the encrypted pieces?</p>
        <div class="mode-cards">
          <div class="mode-card selected" id="modeFree" data-mode="free">
            <div class="mode-card-header">
              <div class="mode-radio"><div class="mode-radio-dot"></div></div>
              <div class="mode-card-title">Free: Manual Split Delivery</div>
              <span class="mode-card-badge">Free</span>
            </div>
            <p class="mode-card-desc">I'll send via two separate channels (Discord + Signal, Email + SMS, etc.)</p>
          </div>
          <div class="mode-card" id="modePro" data-mode="pro">
            <div class="mode-card-header">
              <div class="mode-radio"><div class="mode-radio-dot"></div></div>
              <div class="mode-card-title">Pro: One-Time Link</div>
              <span class="mode-card-badge pro">Coming Soon</span>
            </div>
            <p class="mode-card-desc">Generate a self-destructing link with access logs (recommended for teams)</p>
          </div>
        </div>
        <div style="margin-top: 24px; display: flex; gap: 12px;">
          <button class="btn btn-secondary" id="backToStep1" style="flex: 1;">
            <i data-lucide="arrow-left"></i>
            <span>Back</span>
          </button>
          <button class="btn btn-primary" id="encryptBtn" style="flex: 2;">
            <i data-lucide="lock"></i>
            <span>Encrypt & Split</span>
          </button>
        </div>
      </div>

      <!-- Step 3: Results (Free Mode) -->
      <div class="result-section" id="resultsFree">
        <div class="piece-box warning">
          <div class="piece-header">
            <div class="piece-icon">
              <i data-lucide="package"></i>
            </div>
            <div class="piece-title">ðŸ“¦ PIECE A: Encrypted Blob</div>
          </div>
          <div class="piece-value-box">
            <div class="piece-value" id="pieceAValue"></div>
            <button class="piece-copy-btn" id="copyPieceA">
              <i data-lucide="copy"></i>
              <span>Copy</span>
            </button>
          </div>
          <p class="piece-instruction"><strong>Send via Channel A</strong> (e.g., Discord, Email, Slack)</p>
        </div>

        <div class="warning-box" id="warningBox">
          <i data-lucide="alert-triangle"></i>
          <div class="warning-text">
            <strong>CRITICAL:</strong> Do not reveal Piece B until you've sent Piece A via a different channel. This is the security guarantee.
          </div>
        </div>

        <button class="btn btn-primary" id="revealPieceB">
          <i data-lucide="unlock"></i>
          <span>I've sent Piece A â†’ Reveal Piece B</span>
        </button>

        <div class="piece-box success" id="pieceBBox" style="display: none; margin-top: 24px;">
          <div class="piece-header">
            <div class="piece-icon">
              <i data-lucide="key"></i>
            </div>
            <div class="piece-title">ðŸ”‘ PIECE B: Passphrase</div>
          </div>
          <div class="piece-value-box">
            <div class="piece-value" id="pieceBValue"></div>
            <button class="piece-copy-btn" id="copyPieceB">
              <i data-lucide="copy"></i>
              <span>Copy</span>
            </button>
          </div>
          <p class="piece-instruction"><strong>Send via Channel B</strong> (e.g., Signal, SMS, WhatsApp) â€” different from Channel A</p>
        </div>

        <button class="btn btn-secondary" id="startOver" style="margin-top: 24px;">
          <i data-lucide="refresh-cw"></i>
          <span>Encrypt Another Key</span>
        </button>
      </div>

      <!-- Step 3: Results (Pro Mode - Placeholder) -->
      <div class="result-section" id="resultsPro">
        <div class="piece-box">
          <div class="piece-header">
            <div class="piece-icon">
              <i data-lucide="link"></i>
            </div>
            <div class="piece-title">One-Time Link</div>
          </div>
          <div class="piece-value-box">
            <div class="piece-value">https://apisecure.app/d/abc123xyz789</div>
            <button class="piece-copy-btn">
              <i data-lucide="copy"></i>
              <span>Copy</span>
            </button>
          </div>
          <p class="piece-instruction">
            Link expires in: <strong>1 hour</strong><br>
            Access logs will show who accessed this link and when.
          </p>
        </div>
        <div class="warning-box">
          <i data-lucide="info"></i>
          <div class="warning-text">
            <strong>Pro feature coming soon!</strong> For now, use Free mode for manual split delivery.
          </div>
        </div>
      </div>
    </div>
  </main>

  <div class="toast" id="toast">
    <i data-lucide="check-circle"></i>
    <span id="toastMessage">Copied to clipboard</span>
  </div>

  <script>
    lucide.createIcons();

    // Particle animation
    const canvas = document.getElementById('particleCanvas');
    const ctx = canvas.getContext('2d');
    let particles = [];

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    class Particle {
      constructor() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.vx = (Math.random() - 0.5) * 0.5;
        this.vy = (Math.random() - 0.5) * 0.5;
        this.radius = Math.random() * 2 + 1;
      }
      update() {
        this.x += this.vx;
        this.y += this.vy;
        if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
        if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
      }
      draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(0, 212, 255, 0.5)';
        ctx.fill();
      }
    }

    function initParticles() {
      particles = [];
      const count = Math.min(80, Math.floor((canvas.width * canvas.height) / 15000));
      for (let i = 0; i < count; i++) particles.push(new Particle());
    }

    function drawConnections() {
      const maxDist = 150;
      for (let i = 0; i < particles.length; i++) {
        let connections = 0;
        for (let j = i + 1; j < particles.length; j++) {
          const dx = particles[i].x - particles[j].x;
          const dy = particles[i].y - particles[j].y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < maxDist && connections < 3) {
            const opacity = (1 - dist / maxDist) * 0.2;
            ctx.beginPath();
            ctx.moveTo(particles[i].x, particles[i].y);
            ctx.lineTo(particles[j].x, particles[j].y);
            ctx.strokeStyle = `rgba(0, 212, 255, ${opacity})`;
            ctx.lineWidth = 1;
            ctx.stroke();
            connections++;
          }
        }
      }
    }

    function animateParticles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      particles.forEach(p => { p.update(); p.draw(); });
      drawConnections();
      requestAnimationFrame(animateParticles);
    }

    resizeCanvas();
    initParticles();
    animateParticles();
    window.addEventListener('resize', () => { resizeCanvas(); initParticles(); });

    // Generate passphrase
    function generatePassphrase(len = 24) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      const vals = new Uint8Array(len);
      crypto.getRandomValues(vals);
      for (let i = 0; i < len; i++) result += chars[vals[i] % chars.length];
      return result;
    }

    let currentPassphrase = generatePassphrase();
    let encryptedBlob = '';
    let selectedMode = 'free';

    // DOM elements
    const apiKeyInput = document.getElementById('apiKeyInput');
    const toggleVis = document.getElementById('toggleVisibility');
    const continueToMode = document.getElementById('continueToMode');
    const backToStep1 = document.getElementById('backToStep1');
    const encryptBtn = document.getElementById('encryptBtn');
    const modeFree = document.getElementById('modeFree');
    const modePro = document.getElementById('modePro');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const resultsFree = document.getElementById('resultsFree');
    const resultsPro = document.getElementById('resultsPro');
    const pieceAValue = document.getElementById('pieceAValue');
    const pieceBValue = document.getElementById('pieceBValue');
    const pieceBBox = document.getElementById('pieceBBox');
    const warningBox = document.getElementById('warningBox');
    const revealPieceB = document.getElementById('revealPieceB');
    const copyPieceA = document.getElementById('copyPieceA');
    const copyPieceB = document.getElementById('copyPieceB');
    const startOver = document.getElementById('startOver');
    const toast = document.getElementById('toast');
    const toastMsg = document.getElementById('toastMessage');

    // Toggle visibility
    let isVisible = false;
    toggleVis.addEventListener('click', () => {
      isVisible = !isVisible;
      apiKeyInput.type = isVisible ? 'text' : 'password';
      toggleVis.innerHTML = isVisible ? '<i data-lucide="eye-off"></i>' : '<i data-lucide="eye"></i>';
      lucide.createIcons();
    });

    // Continue to mode selection
    continueToMode.addEventListener('click', () => {
      const apiKey = apiKeyInput.value.trim();
      if (!apiKey) {
        apiKeyInput.focus();
        showToast('Please enter an API key', true);
        return;
      }
      step1.classList.add('hidden');
      step2.classList.remove('hidden');
    });

    // Back to step 1
    backToStep1.addEventListener('click', () => {
      step2.classList.add('hidden');
      step1.classList.remove('hidden');
    });

    // Mode selection
    [modeFree, modePro].forEach(card => {
      card.addEventListener('click', () => {
        [modeFree, modePro].forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        selectedMode = card.dataset.mode;
      });
    });

    // Encrypt button
    encryptBtn.addEventListener('click', async () => {
      if (selectedMode === 'pro') {
        showToast('Pro mode coming soon! Use Free mode for now.', true);
        return;
      }
      await encryptApiKey();
    });

    // Encryption function
    async function encryptApiKey() {
      const apiKey = apiKeyInput.value.trim();
      if (!apiKey) {
        showToast('Please enter an API key', true);
        return;
      }

      encryptBtn.disabled = true;
      encryptBtn.innerHTML = '<div class="spinner"></div><span>Encrypting...</span>';

      try {
        const encoder = new TextEncoder();
        const keyMat = await crypto.subtle.importKey('raw', encoder.encode(currentPassphrase), 'PBKDF2', false, ['deriveBits', 'deriveKey']);

        const salt = crypto.getRandomValues(new Uint8Array(16));
        const iv = crypto.getRandomValues(new Uint8Array(12));

        const key = await crypto.subtle.deriveKey(
          { name: 'PBKDF2', salt: salt, iterations: 100000, hash: 'SHA-256' },
          keyMat, { name: 'AES-GCM', length: 256 }, false, ['encrypt']
        );

        const ciphertext = await crypto.subtle.encrypt(
          { name: 'AES-GCM', iv: iv, additionalData: encoder.encode('api-key-secure-send-v1') },
          key, encoder.encode(apiKey)
        );

        const version = new Uint8Array([2]);
        const algo = new Uint8Array([1]);
        const authTag = new Uint8Array(ciphertext.slice(-16));
        const actualCipher = new Uint8Array(ciphertext.slice(0, -16));

        const combined = new Uint8Array(1 + 1 + 16 + 12 + actualCipher.length + 16);
        let offset = 0;
        combined.set(version, offset); offset += 1;
        combined.set(algo, offset); offset += 1;
        combined.set(salt, offset); offset += 16;
        combined.set(iv, offset); offset += 12;
        combined.set(actualCipher, offset); offset += actualCipher.length;
        combined.set(authTag, offset);

        const base64 = btoa(Array.from(combined, byte => String.fromCharCode(byte)).join(''));
        encryptedBlob = `SECDROP-P:${base64}`;

        pieceAValue.textContent = encryptedBlob;
        pieceBValue.textContent = currentPassphrase;

        step2.classList.add('hidden');
        resultsFree.classList.add('visible');
        
        showToast('Encryption complete!');
      } catch (error) {
        console.error('Encryption error:', error);
        showToast('Encryption failed. Please try again.', true);
      } finally {
        encryptBtn.disabled = false;
        encryptBtn.innerHTML = '<i data-lucide="lock"></i><span>Encrypt & Split</span>';
        lucide.createIcons();
      }
    }

    // Reveal Piece B
    revealPieceB.addEventListener('click', () => {
      pieceBBox.style.display = 'block';
      warningBox.style.display = 'none';
      revealPieceB.style.display = 'none';
      showToast('Piece B revealed. Send via different channel!');
    });

    // Copy functions
    async function copyToClipboard(text, button) {
      try {
        await navigator.clipboard.writeText(text);
        const originalHTML = button.innerHTML;
        button.classList.add('copied');
        button.innerHTML = '<i data-lucide="check"></i><span>Copied!</span>';
        lucide.createIcons();
        setTimeout(() => {
          button.classList.remove('copied');
          button.innerHTML = originalHTML;
          lucide.createIcons();
        }, 2000);
      } catch (err) {
        showToast('Failed to copy', true);
      }
    }

    copyPieceA.addEventListener('click', () => copyToClipboard(encryptedBlob, copyPieceA));
    copyPieceB.addEventListener('click', () => copyToClipboard(currentPassphrase, copyPieceB));

    // Start over
    startOver.addEventListener('click', () => {
      apiKeyInput.value = '';
      currentPassphrase = generatePassphrase();
      encryptedBlob = '';
      selectedMode = 'free';
      
      resultsFree.classList.remove('visible');
      pieceBBox.style.display = 'none';
      warningBox.style.display = 'flex';
      revealPieceB.style.display = 'flex';
      
      step1.classList.remove('hidden');
      apiKeyInput.focus();
    });

    // Toast
    function showToast(msg, isError = false) {
      toastMsg.textContent = msg;
      toast.querySelector('i').style.color = isError ? 'var(--danger)' : 'var(--green)';
      toast.classList.add('visible');
      setTimeout(() => toast.classList.remove('visible'), 2500);
    }

    // Keyboard shortcuts
    apiKeyInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !continueToMode.disabled) continueToMode.click();
    });

    apiKeyInput.focus();
  </script>
</body>
</html>
